<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dream Leaks Cleaner - Lua Deobfuscator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-purple-900 to-slate-900 p-4">
  <div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8 pt-8">
      <div class="flex items-center justify-center gap-3 mb-4">
        <svg class="w-12 h-12 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
        </svg>
        <h1 class="text-4xl font-bold text-white">Dream Leaks Cleaner</h1>
      </div>
      <p class="text-purple-200 text-lg">
        Clean and deobfuscate Lua files for FiveM
      </p>
      <div class="mt-4 inline-flex items-center gap-2 bg-purple-500/20 px-4 py-2 rounded-full border border-purple-500/30">
        <span class="text-purple-300 text-sm font-semibold">
          üìä Files Cleaned: <span id="filesProcessed">0</span>
        </span>
      </div>
    </div>

    <!-- Main Card -->
    <div class="bg-slate-800/50 backdrop-blur-lg rounded-2xl shadow-2xl border border-purple-500/20 p-8">
      <!-- Upload Section -->
      <div id="uploadSection" class="text-center">
        <label for="file-upload" class="cursor-pointer">
          <div class="border-2 border-dashed border-purple-500/50 rounded-xl p-12 hover:border-purple-400 hover:bg-purple-500/5 transition-all">
            <svg class="w-16 h-16 text-purple-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            <p class="text-xl text-white font-semibold mb-2">Upload Lua File</p>
            <p class="text-purple-300">Click to browse or drag and drop</p>
            <p class="text-sm text-purple-400 mt-2">Only .lua files accepted</p>
          </div>
          <input id="file-upload" type="file" accept=".lua" class="hidden">
        </label>
      </div>

      <!-- File Ready Section -->
      <div id="readySection" class="hidden space-y-6">
        <div class="bg-slate-700/50 rounded-lg p-4 border border-purple-500/30">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <svg class="w-8 h-8 text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path>
              </svg>
              <div>
                <p class="text-white font-semibold" id="fileName"></p>
                <p class="text-sm text-purple-300">Ready to clean</p>
              </div>
            </div>
            <button onclick="reset()" class="p-2 hover:bg-red-500/20 rounded-lg transition-colors">
              <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
              </svg>
            </button>
          </div>
        </div>
        <button onclick="processFile()" class="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all transform hover:scale-105">
          üßπ Clean Lua File
        </button>
      </div>

      <!-- Processing Section -->
      <div id="processingSection" class="hidden text-center space-y-6">
        <svg class="w-16 h-16 text-purple-400 mx-auto animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
        </svg>
        <div>
          <p class="text-xl text-white font-semibold mb-2" id="progressMessage">Starting...</p>
          <div class="bg-slate-700 rounded-full h-3 overflow-hidden">
            <div id="progressBar" class="bg-gradient-to-r from-purple-500 to-pink-500 h-full transition-all duration-300" style="width: 0%"></div>
          </div>
          <p class="text-purple-300 mt-2">
            <span id="progressCurrent">0</span> / <span id="progressTotal">0</span> chunks processed
          </p>
        </div>
      </div>

      <!-- Success Section -->
      <div id="successSection" class="hidden space-y-6">
        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-6 text-center">
          <div class="text-6xl mb-4">‚ú®</div>
          <p class="text-2xl text-white font-bold mb-2">Code Cleaned Successfully!</p>
          <p class="text-green-300" id="cleanedFileName"></p>
        </div>
        <div class="flex gap-4">
          <button onclick="downloadCleanedFile()" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Download Cleaned File
          </button>
          <button onclick="reset()" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
            </svg>
            Clean Another File
          </button>
        </div>
      </div>

      <!-- Error Section -->
      <div id="errorSection" class="hidden space-y-6">
        <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-6 text-center">
          <div class="text-6xl mb-4">‚ùå</div>
          <p class="text-2xl text-white font-bold mb-2">Error</p>
          <p class="text-red-300" id="errorMessage"></p>
        </div>
        <button onclick="reset()" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all">
          Try Again
        </button>
      </div>
    </div>

    <!-- Footer Info -->
    <div class="mt-8 text-center">
      <div class="inline-flex flex-col gap-2 bg-slate-800/30 backdrop-blur-sm px-6 py-4 rounded-xl border border-purple-500/20">
        <p class="text-purple-300 text-sm">‚úÖ No API keys required ‚Ä¢ Works directly in browser</p>
        <p class="text-purple-400 text-xs">üîí Your files are processed securely and never stored</p>
      </div>
    </div>
  </div>

  <script>
    let currentFile = null;
    let cleanedCode = '';
    let filesProcessed = 0;

    document.getElementById('file-upload').addEventListener('change', handleFileUpload);

    function handleFileUpload(e) {
      const uploadedFile = e.target.files[0];
      if (uploadedFile) {
        if (uploadedFile.name.endsWith('.lua')) {
          currentFile = uploadedFile;
          document.getElementById('fileName').textContent = uploadedFile.name;
          showSection('readySection');
        } else {
          showError('Only .lua files are accepted / Solo file .lua sono accettati');
        }
      }
    }

    function showSection(section) {
      ['uploadSection', 'readySection', 'processingSection', 'successSection', 'errorSection'].forEach(s => {
        document.getElementById(s).classList.add('hidden');
      });
      document.getElementById(section).classList.remove('hidden');
    }

    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      showSection('errorSection');
    }

    function reset() {
      currentFile = null;
      cleanedCode = '';
      document.getElementById('file-upload').value = '';
      showSection('uploadSection');
    }

    function shouldCleanLua(code) {
      return code.includes('local L0_1');
    }

    function splitIntoChunks(code, chunkSize = 600) {
      const lines = code.split('\n');
      const chunks = [];
      for (let i = 0; i < lines.length; i += chunkSize) {
        chunks.push(lines.slice(i, i + chunkSize).join('\n'));
      }
      return chunks;
    }

    async function cleanChunk(chunk, chunkIndex) {
      const prompt = `Clean and deobfuscate this Lua code chunk. This is part ${chunkIndex + 1} of a larger file. Remove all obfuscation, simplify variable names to be readable, remove unnecessary complexity, and make the code clean and understandable.

Rules:
- Keep all functionality intact
- Use clear, descriptive variable names
- Remove obfuscation techniques
- Maintain proper Lua syntax
- Remove unnecessary whitespace and formatting issues
- Keep comments that add value
- Ensure the chunk can be properly merged with other chunks
- Add short inline comments where useful

IMPORTANT: Return ONLY the cleaned Lua code without any markdown formatting, code blocks, or explanations.

Here's the code to clean:

${chunk}`;

      const response = await fetch("https://api.anthropic.com/v1/messages", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify({
          model: "claude-sonnet-4-20250514",
          max_tokens: 4000,
          messages: [
            { role: "user", content: prompt }
          ],
        })
      });

      if (!response.ok) {
        throw new Error(`API error: ${response.status}`);
      }

      const data = await response.json();
      let cleaned = data.content[0].text.trim();

      if (cleaned.startsWith('```lua')) cleaned = cleaned.slice(6);
      if (cleaned.startsWith('```')) cleaned = cleaned.slice(3);
      if (cleaned.endsWith('```')) cleaned = cleaned.slice(0, -3);

      return cleaned.trim();
    }

    async function processFile() {
      if (!currentFile) return;

      showSection('processingSection');

      try {
        const reader = new FileReader();
        
        reader.onload = async (e) => {
          try {
            const code = e.target.result;
            const lineCount = code.split('\n').length;

            if (lineCount > 500000) {
              showError(`File too large: ${lineCount} lines. Maximum: 500000 lines`);
              return;
            }

            if (!shouldCleanLua(code)) {
              showError('This file does not contain obfuscated code (no "local L0_1" found)');
              return;
            }

            const chunks = splitIntoChunks(code, 600);
            updateProgress(0, chunks.length, 'Starting...');

            const cleanedChunks = [];

            for (let i = 0; i < chunks.length; i++) {
              updateProgress(i + 1, chunks.length, `Cleaning chunk ${i + 1}/${chunks.length}...`);
              const cleanedChunk = await cleanChunk(chunks[i], i);
              cleanedChunks.push(cleanedChunk);
            }

            cleanedCode = cleanedChunks.join('\n');
            filesProcessed++;
            document.getElementById('filesProcessed').textContent = filesProcessed;
            document.getElementById('cleanedFileName').textContent = 'File: ' + currentFile.name.replace('.lua', '_clean.lua');
            showSection('successSection');
          } catch (err) {
            console.error('Processing error:', err);
            showError(`Error processing file: ${err.message}`);
          }
        };

        reader.onerror = () => {
          showError('Error reading file');
        };

        reader.readAsText(currentFile);
      } catch (err) {
        console.error('File read error:', err);
        showError(`Error: ${err.message}`);
      }
    }

    function updateProgress(current, total, message) {
      document.getElementById('progressCurrent').textContent = current;
      document.getElementById('progressTotal').textContent = total;
      document.getElementById('progressMessage').textContent = message;
      const percentage = (current / total) * 100;
      document.getElementById('progressBar').style.width = percentage + '%';
    }

    function downloadCleanedFile() {
      if (!cleanedCode) return;

      const blob = new Blob([cleanedCode], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = currentFile.name.replace('.lua', '_clean.lua');
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
  </script>
</body>
</html>