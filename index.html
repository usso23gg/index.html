<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream Leaks Cleaner - Lua Deobfuscator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900">
    <div id="app" class="p-4">
        <div class="max-w-4xl mx-auto">
            <!-- Header -->
            <div class="text-center mb-8 pt-8">
                <div class="flex items-center justify-center gap-3 mb-4">
                    <svg class="w-12 h-12 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                    </svg>
                    <h1 class="text-4xl font-bold text-white">Dream Leaks Cleaner</h1>
                </div>
                <p class="text-blue-200 text-lg">Clean and deobfuscate Lua files for FiveM</p>
                <p class="text-blue-300 text-sm mt-2">ü§ñ Powered by Google Gemini AI</p>
                <div class="mt-4 inline-flex items-center gap-2 bg-blue-500/20 px-4 py-2 rounded-full border border-blue-500/30">
                    <span class="text-blue-300 text-sm font-semibold" id="stats">üìä Files Cleaned: 0</span>
                </div>
            </div>

            <!-- API Key Input -->
            <div id="apiKeySection" class="bg-slate-800/50 backdrop-blur-lg rounded-2xl shadow-2xl border border-blue-500/20 p-6 mb-6">
                <div class="flex items-center gap-2 mb-4">
                    <svg class="w-5 h-5 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                    </svg>
                    <h2 class="text-xl font-bold text-white">Gemini API Key</h2>
                </div>
                <input type="password" id="apiKeyInput" placeholder="Enter your Gemini API key here..." 
                    class="w-full bg-slate-700/50 text-white px-4 py-3 rounded-lg border border-blue-500/30 focus:border-blue-500 focus:outline-none mb-3">
                <div class="flex gap-2 items-center">
                    <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" 
                        class="text-sm text-blue-400 hover:text-blue-300">
                        üîó Get free API key from Google AI Studio
                    </a>
                    <button id="saveKeyBtn" class="ml-auto text-sm text-green-400 hover:text-green-300 hidden">
                        ‚úì Key saved
                    </button>
                </div>
            </div>

            <!-- Main Card -->
            <div class="bg-slate-800/50 backdrop-blur-lg rounded-2xl shadow-2xl border border-blue-500/20 p-8">
                <!-- Upload Section -->
                <div id="uploadSection" class="text-center">
                    <label for="fileInput" class="cursor-pointer block">
                        <div class="border-2 border-dashed border-blue-500/50 rounded-xl p-12 hover:border-blue-400 hover:bg-blue-500/5 transition-all">
                            <svg class="w-16 h-16 text-blue-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            <p class="text-xl text-white font-semibold mb-2">Upload Lua File</p>
                            <p class="text-blue-300">Click to browse or drag and drop</p>
                            <p class="text-sm text-blue-400 mt-2">Only .lua files accepted</p>
                        </div>
                    </label>
                    <input type="file" id="fileInput" accept=".lua" class="hidden">
                </div>

                <!-- File Ready Section -->
                <div id="fileReadySection" class="space-y-6 hidden">
                    <div class="bg-slate-700/50 rounded-lg p-4 border border-blue-500/30">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <svg class="w-8 h-8 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                                </svg>
                                <div>
                                    <p class="text-white font-semibold" id="fileNameDisplay"></p>
                                    <p class="text-sm text-blue-300">Ready to clean</p>
                                </div>
                            </div>
                            <button id="resetBtn1" class="p-2 hover:bg-red-500/20 rounded-lg transition-colors">
                                <svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <button id="cleanBtn" class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all transform hover:scale-105">
                        üßπ Clean Lua File
                    </button>
                </div>

                <!-- Processing Section -->
                <div id="processingSection" class="text-center space-y-6 hidden">
                    <svg class="w-16 h-16 text-blue-400 mx-auto animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                    </svg>
                    <div>
                        <p class="text-xl text-white font-semibold mb-2" id="progressMessage">Starting...</p>
                        <div class="bg-slate-700 rounded-full h-3 overflow-hidden">
                            <div id="progressBar" class="bg-gradient-to-r from-blue-500 to-cyan-500 h-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                        <p class="text-blue-300 mt-2" id="progressText">0 / 0 chunks processed</p>
                    </div>
                </div>

                <!-- Success Section -->
                <div id="successSection" class="space-y-6 hidden">
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-6 text-center">
                        <div class="text-6xl mb-4">‚ú®</div>
                        <p class="text-2xl text-white font-bold mb-2">Code Cleaned Successfully!</p>
                        <p class="text-green-300" id="cleanedFileName"></p>
                    </div>
                    <div class="flex gap-4">
                        <button id="downloadBtn" class="flex-1 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                            </svg>
                            Download Cleaned File
                        </button>
                        <button id="resetBtn2" class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all flex items-center justify-center gap-2">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                            </svg>
                            Clean Another File
                        </button>
                    </div>
                </div>

                <!-- Error Section -->
                <div id="errorSection" class="space-y-6 hidden">
                    <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-6 text-center">
                        <div class="text-6xl mb-4">‚ùå</div>
                        <p class="text-2xl text-white font-bold mb-2">Error</p>
                        <p class="text-red-300" id="errorMessage"></p>
                    </div>
                    <button id="resetBtn3" class="w-full bg-slate-700 hover:bg-slate-600 text-white font-bold py-4 px-6 rounded-xl shadow-lg transition-all">
                        Try Again
                    </button>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-8 text-center">
                <div class="inline-flex flex-col gap-2 bg-slate-800/30 backdrop-blur-sm px-6 py-4 rounded-xl border border-blue-500/20">
                    <p class="text-blue-300 text-sm">ü§ñ Powered by Google Gemini 1.5 Flash</p>
                    <p class="text-blue-400 text-xs">üîí Your API key is stored only in your browser</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let apiKey = localStorage.getItem('gemini_api_key') || '';
        let currentFile = null;
        let cleanedCode = '';
        let filesProcessed = parseInt(localStorage.getItem('files_processed')) || 0;

        const $ = id => document.getElementById(id);
        const show = id => $(id).classList.remove('hidden');
        const hide = id => $(id).classList.add('hidden');

        // Initialize
        if (apiKey) {
            $('apiKeyInput').value = apiKey;
            show('saveKeyBtn');
        }
        $('stats').textContent = `üìä Files Cleaned: ${filesProcessed}`;

        // API Key handling
        $('apiKeyInput').addEventListener('input', (e) => {
            apiKey = e.target.value;
            localStorage.setItem('gemini_api_key', apiKey);
            if (apiKey) show('saveKeyBtn');
            else hide('saveKeyBtn');
        });

        // File upload
        $('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.name.endsWith('.lua')) {
                showError('Only .lua files are accepted / Solo file .lua sono accettati');
                return;
            }

            currentFile = file;
            $('fileNameDisplay').textContent = file.name;
            hide('uploadSection');
            show('fileReadySection');
        });

        // Clean button
        $('cleanBtn').addEventListener('click', async () => {
            if (!apiKey) {
                showError('Please enter your Gemini API key / Inserisci la tua API key di Gemini');
                return;
            }
            if (!currentFile) return;

            hide('fileReadySection');
            show('processingSection');

            try {
                const code = await currentFile.text();
                const lineCount = code.split('\n').length;

                if (lineCount > 500000) {
                    showError(`File too large: ${lineCount} lines. Maximum: 500000 lines`);
                    return;
                }

                if (!code.includes('local L0_1')) {
                    showError('This file does not contain obfuscated code (no "local L0_1" found)');
                    return;
                }

                const chunks = splitIntoChunks(code, 600);
                const cleanedChunks = [];

                for (let i = 0; i < chunks.length; i++) {
                    updateProgress(i + 1, chunks.length, `Cleaning chunk ${i + 1}/${chunks.length}...`);
                    const cleaned = await cleanChunk(chunks[i], i);
                    cleanedChunks.push(cleaned);
                }

                cleanedCode = cleanedChunks.join('\n');
                filesProcessed++;
                localStorage.setItem('files_processed', filesProcessed);
                $('stats').textContent = `üìä Files Cleaned: ${filesProcessed}`;

                showSuccess();
            } catch (err) {
                console.error('Processing error:', err);
                showError(`Error processing file: ${err.message}`);
            }
        });

        // Download button
        $('downloadBtn').addEventListener('click', () => {
            const blob = new Blob([cleanedCode], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = currentFile.name.replace('.lua', '_clean.lua');
            a.click();
            URL.revokeObjectURL(url);
        });

        // Reset buttons
        [$('resetBtn1'), $('resetBtn2'), $('resetBtn3')].forEach(btn => {
            btn.addEventListener('click', reset);
        });

        function splitIntoChunks(code, chunkSize) {
            const lines = code.split('\n');
            const chunks = [];
            for (let i = 0; i < lines.length; i += chunkSize) {
                chunks.push(lines.slice(i, i + chunkSize).join('\n'));
            }
            return chunks;
        }

        async function cleanChunk(chunk, chunkIndex) {
            const prompt = `Clean and deobfuscate this Lua code chunk. This is part ${chunkIndex + 1} of a larger file. Remove all obfuscation, simplify variable names to be readable, remove unnecessary complexity, and make the code clean and understandable.

Rules:
- Keep all functionality intact
- Use clear, descriptive variable names
- Remove obfuscation techniques
- Maintain proper Lua syntax
- Remove unnecessary whitespace and formatting issues
- Keep comments that add value
- Ensure the chunk can be properly merged with other chunks
- Add short inline comments where useful

IMPORTANT: Return ONLY the cleaned Lua code without any markdown formatting, code blocks, or explanations.

Here's the code to clean:

${chunk}`;

            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(`API error: ${response.status} - ${errorData.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            let cleaned = data.candidates[0].content.parts[0].text.trim();

            // Remove markdown formatting
            if (cleaned.startsWith('```lua')) cleaned = cleaned.slice(6);
            if (cleaned.startsWith('```')) cleaned = cleaned.slice(3);
            if (cleaned.endsWith('```')) cleaned = cleaned.slice(0, -3);

            return cleaned.trim();
        }

        function updateProgress(current, total, message) {
            $('progressMessage').textContent = message;
            $('progressBar').style.width = `${(current / total) * 100}%`;
            $('progressText').textContent = `${current} / ${total} chunks processed`;
        }

        function showSuccess() {
            hide('processingSection');
            show('successSection');
            $('cleanedFileName').textContent = `File: ${currentFile.name.replace('.lua', '_clean.lua')}`;
        }

        function showError(message) {
            hide('uploadSection');
            hide('fileReadySection');
            hide('processingSection');
            hide('successSection');
            show('errorSection');
            $('errorMessage').textContent = message;
        }

        function reset() {
            currentFile = null;
            cleanedCode = '';
            hide('fileReadySection');
            hide('processingSection');
            hide('successSection');
            hide('errorSection');
            show('uploadSection');
            $('fileInput').value = '';
        }
    </script>
</body>
</html>
